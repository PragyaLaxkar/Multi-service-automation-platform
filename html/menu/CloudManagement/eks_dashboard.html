<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8">
  <title>EKS Cluster Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      background-color: #e6f2ff;
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
      transition: background-color 0.3s ease;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #004080;
    }
    .card {
      background-color: white;
      margin-bottom: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }
    .btn-sm {
      margin-right: 5px;
    }
    .badge {
      font-size: 1em;
    }
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }
    html[data-bs-theme="dark"] .card, 
    html[data-bs-theme="dark"] .card * {
      color: black !important;
    }
    html[data-bs-theme="dark"] .card table,
    html[data-bs-theme="dark"] .card th,
    html[data-bs-theme="dark"] .card td {
      color: white !important;
    }
    html[data-bs-theme="dark"] .card th {
      background-color: #222 !important;
    }
    html[data-bs-theme="dark"] .card td {
      background-color: #2c2c2c !important;
    }
  </style>
</head>
<body>

<h1>EKS Cluster Dashboard</h1>

<!-- Theme Toggle Button -->
<div class="theme-toggle">
  <button class="btn btn-outline-dark" onclick="toggleTheme()">🌙</button>
</div>

<div class="container">
  <!-- Dashboard Controls -->
  <div class="dashboard-controls mb-4 p-3 rounded shadow-sm bg-white d-flex flex-wrap align-items-center justify-content-between" style="gap: 1.5rem;">
    <div class="d-flex align-items-center" style="gap:1rem;">
      <label for="regionSelect" class="form-label me-2 mb-0 fw-bold">Region:</label>
      <select id="regionSelect" class="form-select w-auto">
        <option value="us-east-1">us-east-1</option>
        <option value="ap-south-1" selected>ap-south-1</option>
        <option value="eu-west-1">eu-west-1</option>
        <option value="ap-northeast-1">ap-northeast-1</option>
        <option value="ap-northeast-2">ap-northeast-2</option>
      </select>
    </div>
    <div class="d-flex align-items-center" style="gap:1rem;">
      <button class="btn btn-warning fw-bold px-4 py-2" onclick="loadEksClusters()">Refresh</button>
      <a href="/menu/AWSServices/launch_eks.html" class="btn btn-success fw-bold px-4 py-2">Launch New Cluster</a>
    </div>
  </div>
  <!-- Search, Sort, Bulk Actions -->
  <div class="row mb-4 gx-3 gy-2 align-items-center dashboard-filters">
    <div class="col-md-4">
      <input type="text" class="form-control form-control-lg shadow-sm" id="clusterSearch" placeholder="🔍 Search by name or status..." oninput="renderFilteredClusters()">
    </div>
    <div class="col-md-3">
      <select class="form-select form-select-lg shadow-sm" id="clusterSort" onchange="renderFilteredClusters()">
        <option value="createdAt">Sort by Creation Date</option>
        <option value="name">Sort by Name</option>
        <option value="status">Sort by Status</option>
      </select>
    </div>
    <div class="col-md-5 d-flex flex-wrap gap-2">
      <button class="btn btn-outline-danger fw-bold px-3 py-2" onclick="bulkDeleteClusters()">Delete Selected</button>
      <button class="btn btn-outline-primary fw-bold px-3 py-2" onclick="exportClusters('csv')">Export CSV</button>
      <button class="btn btn-outline-success fw-bold px-3 py-2" onclick="exportClusters('json')">Export JSON</button>
    </div>
  </div>
  <div id="eksClusters"></div>
  <input type="hidden" id="allClustersData">
</div>

<script>
let allClusters = [];
let selectedClusters = new Set();

function loadEksClusters() {
  document.getElementById('eksClusters').innerHTML = '<div class="text-center">Loading...</div>';
  const region = document.getElementById('regionSelect').value;
  fetch(`/cgi-bin/eks_dashboard.py?action=list&regionName=${region}`)
    .then(res => res.json())
    .then(async data => {
      if (data.error) {
        document.getElementById('eksClusters').innerHTML = `<div class='alert alert-danger'>${data.error}</div>`;
        return;
      }
      allClusters = data.clusters;
      document.getElementById('allClustersData').value = JSON.stringify(allClusters);
      renderFilteredClusters();
    });
}

function renderFilteredClusters() {
  let clusters = allClusters.slice();
  const search = document.getElementById('clusterSearch').value.toLowerCase();
  const sortBy = document.getElementById('clusterSort').value;
  if (search) {
    clusters = clusters.filter(c => c.name.toLowerCase().includes(search) || c.status.toLowerCase().includes(search));
  }
  clusters.sort((a, b) => {
    if (sortBy === 'createdAt') {
      return new Date(a.createdAt) - new Date(b.createdAt);
    } else if (sortBy === 'name') {
      return a.name.localeCompare(b.name);
    } else if (sortBy === 'status') {
      return a.status.localeCompare(b.status);
    }
    return 0;
  });
  let html = '';
  for (const cluster of clusters) {
    let checked = selectedClusters.has(cluster.name) ? 'checked' : '';
    html += `<div class="card p-4 mb-4 shadow dashboard-card" style="min-height: 320px; border-radius: 1.25rem; background: linear-gradient(135deg, #f8fafc 70%, #e0e7ef 100%);">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <input type="checkbox" class="form-check-input me-2" onchange="toggleClusterSelect('${cluster.name}')" ${checked}>
          <h4 class="d-inline fw-bold text-primary">${cluster.name}</h4>
          <span class="badge bg-secondary ms-2">${cluster.status}</span>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-info btn-sm" onclick="showMetadata('${cluster.name}')">Metadata</button>
          <button class="btn btn-primary btn-sm" onclick="showNodeGroups('${cluster.name}')">Node Groups</button>
          <button class="btn btn-success btn-sm" onclick="showMetrics('${cluster.name}')">Metrics</button>
          <button class="btn btn-warning btn-sm" onclick="showEvents('${cluster.name}')">Events</button>
          <button class="btn btn-secondary btn-sm" onclick="showSecurity('${cluster.name}')">Security & Access</button>
          <button class="btn btn-info btn-sm" onclick="showNetworking('${cluster.name}')">Networking</button>
          <button class="btn btn-outline-dark btn-sm" onclick="showCost('${cluster.name}')">Cost & Utilization</button>
          <button class="btn btn-danger btn-sm" onclick="deleteCluster('${cluster.name}')">Delete</button>
        </div>
      </div>
      <div class="row g-3">
        <div class="col-md-4">
          <div class="bg-light rounded p-3 h-100">
            <strong>Version:</strong><br> <span class="fs-6">${cluster.version}</span>
          </div>
        </div>
        <div class="col-md-4">
          <div class="bg-light rounded p-3 h-100">
            <strong>VPC:</strong><br> <span class="fs-6">${cluster.vpc}</span>
          </div>
        </div>
        <div class="col-md-4">
          <div class="bg-light rounded p-3 h-100">
            <strong>Created:</strong><br> <span class="fs-6">${cluster.createdAt}</span>
          </div>
        </div>
      </div>
      <div class="row mt-3 g-3">
        <div class="col-md-6">
          <div class="bg-white border rounded p-3 h-100">
            <strong>Endpoint:</strong><br> <span class="fs-6 text-break">${cluster.endpoint}</span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="bg-white border rounded p-3 h-100">
            <strong>Subnets:</strong><br> <span class="fs-6 text-break">${cluster.subnets.join(', ')}</span>
          </div>
        </div>
      </div>
    </div>`;
  }
  document.getElementById('eksClusters').innerHTML = html;
}

function toggleClusterSelect(name) {
  if (selectedClusters.has(name)) {
    selectedClusters.delete(name);
  } else {
    selectedClusters.add(name);
  }
}

function bulkDeleteClusters() {
  if (selectedClusters.size === 0) {
    alert('No clusters selected for deletion.');
    return;
  }
  if (!confirm('Are you sure you want to delete the selected clusters?')) return;
  for (const name of selectedClusters) {
    deleteCluster(name);
  }
  selectedClusters.clear();
  setTimeout(loadEksClusters, 2000);
}

function exportClusters(type) {
  let clusters = allClusters.slice();
  if (type === 'csv') {
    let csv = 'Name,Status,Version,VPC,Created,Endpoint,Subnets\n';
    for (const c of clusters) {
      csv += `${c.name},${c.status},${c.version},${c.vpc},${c.createdAt},${c.endpoint},"${c.subnets.join(';')}"\n`;
    }
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'eks_clusters.csv';
    a.click();
    URL.revokeObjectURL(url);
  } else if (type === 'json') {
    const blob = new Blob([JSON.stringify(clusters, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'eks_clusters.json';
    a.click();
    URL.revokeObjectURL(url);
  }
}

function fetchClusters() {
  const region = document.getElementById('regionSelect').value;
  document.getElementById('eksClusters').innerHTML = '<div class="text-center">Loading...</div>';
  fetch(`/cgi-bin/eks_dashboard.py?action=list&regionName=${region}`)
    .then(res => res.json())
    .then(async data => {
      if (data.error) {
        document.getElementById('eksClusters').innerHTML = `<div class='alert alert-danger'>${data.error}</div>`;
        return;
      }
      if (!data.clusters || data.clusters.length === 0) {
        document.getElementById('eksClusters').innerHTML = '<div class="alert alert-info">No clusters found.</div>';
        return;
      }
      let html = '';
      for (const cluster of data.clusters) {
        // Fetch health for cluster
        let health = '...';
        try {
          const healthRes = await fetch(`/cgi-bin/eks_dashboard.py?action=health&regionName=${region}&clusterName=${cluster.name}`);
          const healthData = await healthRes.json();
          health = healthData.health || 'Unknown';
        } catch(e) { health = 'Unknown'; }
        html += `
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">${cluster.name} <span class="badge bg-secondary">${cluster.status}</span> <span class="badge ${health==='Healthy'?'bg-success':'bg-danger'}">${health}</span></h5>
            <div>
              <button class="btn btn-info btn-sm" onclick="showMetadata('${cluster.name}')">Metadata</button>
              <button class="btn btn-primary btn-sm" onclick="showNodeGroups('${cluster.name}')">Node Groups</button>
              <button class="btn btn-success btn-sm" onclick="showMetrics('${cluster.name}')">Metrics</button>
              <button class="btn btn-warning btn-sm" onclick="showEvents('${cluster.name}')">Events</button>
              <button class="btn btn-secondary btn-sm" onclick="showSecurity('${cluster.name}')">Security & Access</button>
              <button class="btn btn-info btn-sm" onclick="showNetworking('${cluster.name}')">Networking</button>
              <button class="btn btn-outline-dark btn-sm" onclick="showCost('${cluster.name}')">Cost & Utilization</button>
              <button class="btn btn-danger btn-sm" onclick="deleteCluster('${cluster.name}')">Delete</button>
            </div>
          </div>
          <div class="mt-2">
            <strong>Version:</strong> ${cluster.version} &nbsp; | &nbsp;
            <strong>VPC:</strong> ${cluster.vpc} &nbsp; | &nbsp;
            <strong>Created:</strong> ${cluster.createdAt}
          </div>
          <div class="mt-2">
            <strong>Endpoint:</strong> <span style="font-size:0.95em;">${cluster.endpoint}</span>
          </div>
          <div class="mt-2">
            <strong>Subnets:</strong> <span style="font-size:0.95em;">${cluster.subnets.join(', ')}</span>
          </div>
        </div>`;
      }
      document.getElementById('eksClusters').innerHTML = html;
    });
}

function showMetadata(name) {
  const region = document.getElementById('regionSelect').value;
  fetch(`/cgi-bin/eks_dashboard.py?action=describe&regionName=${region}&clusterName=${name}`)
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        alert('Error: ' + data.error);
        return;
      }
      const meta = JSON.stringify(data.metadata, null, 2);
      const w = window.open('', '_blank', 'width=600,height=600');
      w.document.write(`<pre>${meta}</pre>`);
    });
}

function deleteCluster(name) {
  if (!confirm(`Are you sure you want to delete cluster ${name}?`)) return;
  const region = document.getElementById('regionSelect').value;
  fetch(`/cgi-bin/eks_dashboard.py?action=delete&regionName=${region}&clusterName=${name}`)
    .then(res => res.json())
    .then(data => {
      alert(data.message || data.error);
      loadEksClusters();
    });
}

function toggleTheme() {
  const html = document.documentElement;
  if (html.getAttribute('data-bs-theme') === 'dark') {
    html.setAttribute('data-bs-theme', 'light');
  } else {
    html.setAttribute('data-bs-theme', 'dark');
  }
}

function showNodeGroups(clusterName) {
  const region = document.getElementById('regionSelect').value;
  fetch(`/cgi-bin/eks_dashboard.py?action=list_nodegroups&regionName=${region}&clusterName=${clusterName}`)
    .then(res => res.json())
    .then(async data => {
      if (data.error) {
        alert('Error: ' + data.error);
        return;
      }
      let html = `<h5>Node Groups for ${clusterName}</h5>`;
      if (!data.nodegroups || data.nodegroups.length === 0) {
        html += '<div class="alert alert-info">No node groups found.</div>';
      } else {
        html += '<ul class="list-group">';
        for (const ng of data.nodegroups) {
          let health = '...';
          try {
            const hRes = await fetch(`/cgi-bin/eks_dashboard.py?action=health&regionName=${region}&clusterName=${clusterName}&nodegroupName=${ng.name}`);
            const hData = await hRes.json();
            health = hData.health || 'Unknown';
          } catch(e) { health = 'Unknown'; }
          html += `<li class="list-group-item">
            <strong>${ng.name}</strong> <span class="badge bg-secondary">${ng.status}</span> <span class="badge ${health==='Healthy'?'bg-success':'bg-danger'}">${health}</span><br>
            <strong>Instance Types:</strong> ${ng.instanceTypes.join(', ')}<br>
            <strong>Scaling:</strong> Min: ${ng.scalingConfig.minSize}, Max: ${ng.scalingConfig.maxSize}, Desired: ${ng.scalingConfig.desiredSize}<br>
            <strong>Subnets:</strong> ${ng.subnets.join(', ')}<br>
            <strong>Role:</strong> ${ng.nodeRole}<br>
            <strong>AMI Type:</strong> ${ng.amiType}<br>
            <strong>Created:</strong> ${ng.createdAt}<br>
            <button class="btn btn-sm btn-outline-info mt-2" onclick="showNodegroupDetails('${clusterName}', '${ng.name}')">Details</button>
            <button class="btn btn-sm btn-success mt-2" onclick="showNodegroupMetrics('${clusterName}', '${ng.name}')">Metrics</button>
            <button class="btn btn-sm btn-warning mt-2" onclick="showNodegroupEvents('${clusterName}', '${ng.name}')">Events</button>
            <button class="btn btn-sm btn-secondary mt-2" onclick="showNodegroupSecurity('${clusterName}', '${ng.name}')">Security & Access</button>
            <button class="btn btn-sm btn-outline-dark mt-2" onclick="showNodegroupCost('${clusterName}', '${ng.name}')">Cost & Utilization</button>
          </li>`;
        }
        html += '</ul>';
      }
      showModal(html);
    });
}

function showMetrics(clusterName) {
  const region = document.getElementById('regionSelect').value;
  Promise.all([
    fetch(`/cgi-bin/eks_dashboard.py?action=metrics&regionName=${region}&clusterName=${clusterName}&metric=CPUUtilization`).then(r=>r.json()),
    fetch(`/cgi-bin/eks_dashboard.py?action=metrics&regionName=${region}&clusterName=${clusterName}&metric=NetworkRxBytes`).then(r=>r.json()),
    fetch(`/cgi-bin/eks_dashboard.py?action=metrics&regionName=${region}&clusterName=${clusterName}&metric=NetworkTxBytes`).then(r=>r.json())
  ]).then(([cpu, rx, tx]) => {
    let html = `<h5>Cluster Metrics for ${clusterName}</h5>`;
    html += `<div><strong>CPU Utilization:</strong> ${JSON.stringify(cpu.metrics)}</div>`;
    html += `<div><strong>Network Rx (Bytes):</strong> ${JSON.stringify(rx.metrics)}</div>`;
    html += `<div><strong>Network Tx (Bytes):</strong> ${JSON.stringify(tx.metrics)}</div>`;
    showModal(html);
  });
}

function showEvents(clusterName) {
  const region = document.getElementById('regionSelect').value;
  fetch(`/cgi-bin/eks_dashboard.py?action=events&regionName=${region}&clusterName=${clusterName}`)
    .then(res => res.json())
    .then(data => {
      let html = `<h5>Recent Events for ${clusterName}</h5>`;
      if (!data.events || data.events.length === 0) {
        html += '<div class="alert alert-info">No recent events.</div>';
      } else {
        html += '<pre>' + JSON.stringify(data.events, null, 2) + '</pre>';
      }
      showModal(html);
    });
}

function showNodegroupDetails(clusterName, nodegroupName) {
  const region = document.getElementById('regionSelect').value;
  fetch(`/cgi-bin/eks_dashboard.py?action=nodegroup_details&regionName=${region}&clusterName=${clusterName}&nodegroupName=${nodegroupName}`)
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        alert('Error: ' + data.error);
        return;
      }
      const meta = JSON.stringify(data.nodegroup, null, 2);
      showModal(`<h5>Node Group: ${nodegroupName}</h5><pre>${meta}</pre>`);
    });
}

function showNodegroupMetrics(clusterName, nodegroupName) {
  const region = document.getElementById('regionSelect').value;
  Promise.all([
    fetch(`/cgi-bin/eks_dashboard.py?action=metrics&regionName=${region}&clusterName=${clusterName}&nodegroupName=${nodegroupName}&metric=CPUUtilization`).then(r=>r.json()),
    fetch(`/cgi-bin/eks_dashboard.py?action=metrics&regionName=${region}&clusterName=${clusterName}&nodegroupName=${nodegroupName}&metric=NetworkRxBytes`).then(r=>r.json()),
    fetch(`/cgi-bin/eks_dashboard.py?action=metrics&regionName=${region}&clusterName=${clusterName}&nodegroupName=${nodegroupName}&metric=NetworkTxBytes`).then(r=>r.json())
  ]).then(([cpu, rx, tx]) => {
    let html = `<h5>Node Group Metrics for ${nodegroupName}</h5>`;
    html += `<div><strong>CPU Utilization:</strong> ${JSON.stringify(cpu.metrics)}</div>`;
    html += `<div><strong>Network Rx (Bytes):</strong> ${JSON.stringify(rx.metrics)}</div>`;
    html += `<div><strong>Network Tx (Bytes):</strong> ${JSON.stringify(tx.metrics)}</div>`;
    showModal(html);
  });
}

function showNodegroupEvents(clusterName, nodegroupName) {
  const region = document.getElementById('regionSelect').value;
  fetch(`/cgi-bin/eks_dashboard.py?action=events&regionName=${region}&clusterName=${clusterName}&nodegroupName=${nodegroupName}`)
    .then(res => res.json())
    .then(data => {
      let html = `<h5>Recent Events for ${nodegroupName}</h5>`;
      if (!data.events || data.events.length === 0) {
        html += '<div class="alert alert-info">No recent events.</div>';
      } else {
        html += '<pre>' + JSON.stringify(data.events, null, 2) + '</pre>';
      }
      showModal(html);
    });
}

function showSecurity(clusterName) {
  const region = document.getElementById('regionSelect').value;
  fetch(`/cgi-bin/eks_dashboard.py?action=security_access&regionName=${region}&clusterName=${clusterName}`)
    .then(res => res.json())
    .then(data => {
      let html = `<h5>Security & Access for ${clusterName}</h5>`;
      if (data.error) {
        html += `<div class='alert alert-danger'>${data.error}</div>`;
      } else {
        html += `<div><strong>IAM Role ARN:</strong> ${data.clusterRole}</div>`;
        html += `<div><strong>API Endpoint Access:</strong> Public: ${data.endpointAccess.publicAccess}, Private: ${data.endpointAccess.privateAccess}</div>`;
        html += `<div><strong>Public Access CIDRs:</strong> ${data.endpointAccess.publicAccessCidrs.join(', ')}</div>`;
        html += `<div><strong>OIDC Issuer:</strong> ${data.oidcIssuer}</div>`;
      }
      showModal(html);
    });
}

function showNodegroupSecurity(clusterName, nodegroupName) {
  const region = document.getElementById('regionSelect').value;
  fetch(`/cgi-bin/eks_dashboard.py?action=security_access&regionName=${region}&clusterName=${clusterName}&nodegroupName=${nodegroupName}`)
    .then(res => res.json())
    .then(data => {
      let html = `<h5>Security & Access for Node Group ${nodegroupName}</h5>`;
      if (data.error) {
        html += `<div class='alert alert-danger'>${data.error}</div>`;
      } else {
        html += `<div><strong>IAM Role ARN:</strong> ${data.nodeRole}</div>`;
        html += `<div><strong>AMI Type:</strong> ${data.amiType}</div>`;
        html += `<div><strong>OIDC Enabled Tag:</strong> ${data.oidc}</div>`;
      }
      showModal(html);
    });
}

function showNetworking(clusterName) {
  const region = document.getElementById('regionSelect').value;
  fetch(`/cgi-bin/eks_dashboard.py?action=networking&regionName=${region}&clusterName=${clusterName}`)
    .then(res => res.json())
    .then(data => {
      let html = `<h5>Networking for ${clusterName}</h5>`;
      if (data.error) {
        html += `<div class='alert alert-danger'>${data.error}</div>`;
      } else {
        html += `<div><strong>VPC ID:</strong> ${data.vpcId}</div>`;
        html += `<div><strong>Subnets:</strong> ${data.subnetIds.join(', ')}</div>`;
        html += `<div><strong>Security Groups:</strong> ${data.securityGroupIds.join(', ')}</div>`;
        html += `<div><strong>Endpoint Public Access:</strong> ${data.endpointPublicAccess}</div>`;
        html += `<div><strong>Endpoint Private Access:</strong> ${data.endpointPrivateAccess}</div>`;
        html += `<div><strong>Public Access CIDRs:</strong> ${data.publicAccessCidrs.join(', ')}</div>`;
      }
      showModal(html);
    });
}

function showCost(clusterName) {
  const region = document.getElementById('regionSelect').value;
  fetch(`/cgi-bin/eks_dashboard.py?action=cost_utilization&regionName=${region}&clusterName=${clusterName}`)
    .then(res => res.json())
    .then(data => {
      let html = `<h5>Estimated Cost & Utilization for ${clusterName}</h5>`;
      if (data.error) {
        html += `<div class='alert alert-danger'>${data.error}</div>`;
      } else {
        html += `<div><strong>Estimated Hourly Cost:</strong> $${data.estimatedHourlyCost}</div>`;
        html += `<div><strong>Estimated Monthly Cost:</strong> $${data.estimatedMonthlyCost}</div>`;
        if (data.nodegroups) {
          html += `<div class='mt-2'><strong>Node Groups:</strong><ul>`;
          for (const ng of data.nodegroups) {
            html += `<li>${ng.name}: ${ng.nodeCount} nodes [${ng.instanceTypes.join(', ')}], Hourly: $${ng.hourlyCost}</li>`;
          }
          html += '</ul></div>';
        }
      }
      showModal(html);
    });
}

function showNodegroupCost(clusterName, nodegroupName) {
  const region = document.getElementById('regionSelect').value;
  fetch(`/cgi-bin/eks_dashboard.py?action=cost_utilization&regionName=${region}&clusterName=${clusterName}&nodegroupName=${nodegroupName}`)
    .then(res => res.json())
    .then(data => {
      let html = `<h5>Estimated Cost & Utilization for Node Group ${nodegroupName}</h5>`;
      if (data.error) {
        html += `<div class='alert alert-danger'>${data.error}</div>`;
      } else {
        html += `<div><strong>Estimated Hourly Cost:</strong> $${data.estimatedHourlyCost}</div>`;
        html += `<div><strong>Estimated Monthly Cost:</strong> $${data.estimatedMonthlyCost}</div>`;
        html += `<div><strong>Node Count:</strong> ${data.nodeCount}</div>`;
        html += `<div><strong>Instance Types:</strong> ${data.instanceTypes.join(', ')}</div>`;
      }
      showModal(html);
    });
}

function showModal(content) {
  let modal = document.getElementById('eksModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'eksModal';
    modal.className = 'modal fade';
    modal.tabIndex = -1;
    modal.innerHTML = `
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="eksModalBody"></div>
      </div>
    </div>`;
    document.body.appendChild(modal);
  }
  document.getElementById('eksModalBody').innerHTML = content;
  const bsModal = new bootstrap.Modal(modal);
  bsModal.show();
}

// Load on page load
loadEksClusters();
</script>

</body>
</html>