<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://unpkg.com/axios@0.24.0/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

    <title>IAM User Management</title>

    <style>
        .spinner-border {
            display: none;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container my-5">
        <h2 class="text-center mb-4">IAM User Management Dashboard</h2>
        <div class="card p-4 shadow-sm">
            <form id="iamForm" onsubmit="event.preventDefault(); manage_iam();">
                <div class="row g-3 align-items-center mb-2">
                    <div class="col-md-4">
                        <input class="form-control" id="name" type="text" placeholder="Enter IAM user name">
                    </div>
                    <div class="col-md-4">
                        <input class="form-control" id="password" type="password" placeholder="Enter IAM user password">
                    </div>
                    <div class="col-md-4" id="loginProfileDiv">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableLoginProfile">
                            <label class="form-check-label" for="enableLoginProfile">
                                Enable Login Profile
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <select class="form-select" id="action" onchange="updateFormFields()">
                        <option value="create">Create User</option>
                        <option value="delete">Delete User</option>
                        <option value="list-users">List Users</option>
                        <option value="create-access-key">Create Access Key</option>
                        <option value="delete-access-key">Delete Access Key</option>
                        <option value="create-login-profile">Enable Login Profile</option>
                        <option value="delete-login-profile">Disable Login Profile</option>
                        <option value="list-policies">List Attached Policies</option>
                        <option value="get-user">Get User Details</option>
                        <option value="create-group">Create Group</option>
                        <option value="delete-group">Delete Group</option>
                        <option value="add-user-to-group">Add User to Group</option>
                        <option value="attach-user-policy">Attach Policy to User</option>
                        <option value="detach-user-policy">Detach Policy from User</option>
                        <option value="attach-group-policy">Attach Policy to Group</option>
                        <option value="detach-group-policy">Detach Policy from Group</option>
                        <option value="generate-credential-report">Generate Credential Report</option>
                    </select>
                </div>
                <div class="mb-3" id="policySection" style="display:none;">
                    <input class="form-control mb-2" id="policySearch" type="text" placeholder="Search Policies...">
                    <select class="form-select" id="policy">
                        <option value="">-- Select AWS Managed Policy --</option>
                    </select>
                </div>
                <div class="mb-3" id="groupSection" style="display:none;">
                    <input class="form-control" id="group" type="text" placeholder="Enter Group name">
                </div>
                <div class="d-grid mb-2">
                    <button type="submit" class="btn btn-primary" id="submitBtn">Submit</button>
                </div>
                <div class="text-center my-2">
                    <div class="spinner-border text-primary" role="status" id="spinner"></div>
                </div>
            </form>
        </div>
        <div class="card mt-4 shadow-sm">
            <div class="card-header">Results</div>
            <div class="card-body">
                <div id="content" class="mb-3"></div>
                <button class="btn btn-outline-secondary me-2" onclick="downloadCSV()">Download CSV</button>
                <button class="btn btn-outline-secondary" onclick="downloadJSON()">Download JSON</button>
            </div>
        </div>
    </div>

    <script>
        const spinner = document.getElementById("spinner");
        const content = document.getElementById("content");
        document.getElementById("loginProfileDiv").style.display = "none";

        function updateFormFields() {
            const action = document.getElementById("action").value;
            // Show/hide password
            document.getElementById("password").parentElement.style.display = ["create", "create-login-profile"].includes(action) ? "block" : "none";
            // Show/hide login profile checkbox
            document.getElementById("loginProfileDiv").style.display = action === "create" ? "block" : "none";
            // Show/hide policy section
            const policyActions = ["attach-user-policy", "detach-user-policy", "attach-group-policy", "detach-group-policy"];
            document.getElementById("policySection").style.display = policyActions.includes(action) ? "block" : "none";
            // Show/hide group section
            const groupActions = ["create-group", "delete-group", "add-user-to-group", "attach-group-policy", "detach-group-policy"];
            document.getElementById("groupSection").style.display = groupActions.includes(action) ? "block" : "none";
        }
        document.getElementById("action").addEventListener("change", updateFormFields);
        window.onload = updateFormFields;

        // Filter policy options by search
        document.getElementById("policySearch").addEventListener("input", function () {
            const search = this.value.toLowerCase();
            const options = document.getElementById("policy").options;
            for (let i = 0; i <options.length; i++) {
                const text = options[i].textContent.toLowerCase();
                options[i].style.display = text.includes(search) ? "" : "none";
            }
        });

        async function populatePolicies() {
            // Default AWS managed policies
            const defaultPolicies = [
                { PolicyName: "AdministratorAccess", Arn: "arn:aws:iam::aws:policy/AdministratorAccess" },
                { PolicyName: "AmazonEC2FullAccess", Arn: "arn:aws:iam::aws:policy/AmazonEC2FullAccess" },
                { PolicyName: "AmazonS3FullAccess", Arn: "arn:aws:iam::aws:policy/AmazonS3FullAccess" },
                { PolicyName: "AWSLambda_FullAccess", Arn: "arn:aws:iam::aws:policy/AWSLambda_FullAccess" },
                { PolicyName: "AmazonAPIGatewayAdministrator", Arn: "arn:aws:iam::aws:policy/AmazonAPIGatewayAdministrator" }
            ];
            const policySelect = document.getElementById("policy");
            policySelect.innerHTML = '<option value="">-- Select AWS Managed Policy --</option>';
            defaultPolicies.forEach(p => {
                const option = document.createElement("option");
                option.value = p.Arn;
                option.textContent = `${p.PolicyName}  (${p.Arn})`;
                policySelect.appendChild(option);
            });
            try {
                const res = await fetch("/cgi-bin/iam.py?action=list-all-policies");
                const data = await res.json();
                if (data.Policies && Array.isArray(data.Policies)) {
                    data.Policies.forEach(p => {
                        if (!defaultPolicies.some(dp => dp.Arn === p.Arn)) {
                            const option = document.createElement("option");
                            option.value = p.Arn;
                            option.textContent = `${p.PolicyName}  (${p.Arn})`;
                            policySelect.appendChild(option);
                        }
                    });
                }
            } catch (e) {
                // If fetch fails, default policies are already loaded
            }
        }
        populatePolicies();

        function manage_iam() {
            const name = document.getElementById("name").value;
            const password = document.getElementById("password").value;
            const action = document.getElementById("action").value;
            const policy = document.getElementById("policy").value;
            const group = document.getElementById("group").value;

            spinner.style.display = "inline-block";
            content.innerHTML = "";

            const params = new URLSearchParams({
                name,
                action,
                password,
                policy_arn: policy,
                group_name: group
            });

            fetch("/cgi-bin/iam.py", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: params.toString()
            })
                .then(res => res.text())
                .then(data => {
                    content.innerHTML = `<pre>${data}</pre>`;
                })
                .catch(err => {
                    content.innerHTML = `Error: ${err}`;
                })
                .finally(() => {
                    spinner.style.display = "none";
                });
        }

        function downloadCSV() {
            const blob = new Blob([content.innerText], { type: "text/csv" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "iam-data.csv";
            link.click();
        }

        function downloadJSON() {
            try {
                const jsonData = JSON.stringify(eval('(' + content.innerText + ')'), null, 2);
                const blob = new Blob([jsonData], { type: "application/json" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "iam-data.json";
                link.click();
            } catch (e) {
                alert("Data is not in valid JSON format.");
            }
        }
    </script>
</body>

</html>